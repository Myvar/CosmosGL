port of this code:
http://stevehanov.ca/blog/index.php?id=143